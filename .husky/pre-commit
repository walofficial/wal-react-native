#!/usr/bin/env bash
set -e

# Ensure node is available in PATH
if ! command -v node &> /dev/null; then
  # Try common Node.js installation locations
  for node_path in \
    "/opt/homebrew/bin/node" \
    "/usr/local/bin/node" \
    "/usr/bin/node" \
    "$HOME/.nvm/versions/node/*/bin/node"
  do
    if [ -x "$node_path" ]; then
      export PATH="$(dirname "$node_path"):$PATH"
      break
    fi
  done

  # Final check if node is now available
  if ! command -v node &> /dev/null; then
    echo "Error: Node.js not found. Please ensure Node.js is installed and available in PATH" >&2
    echo "Tip: If using VS Code, make sure it inherits your shell environment" >&2
    exit 127
  fi
fi

# Get list of staged files
FILES=$(git diff --cached --name-only --diff-filter=ACMR | sed 's| |\\ |g')
[ -z "$FILES" ] && exit 0

# Run prettier on staged files
if [ -f "./node_modules/.bin/prettier" ]; then
  echo "$FILES" | xargs ./node_modules/.bin/prettier --ignore-unknown --write
  echo "$FILES" | xargs git add
fi

# Run lint-staged and TypeScript checks
if [ -f "./node_modules/lint-staged/bin/lint-staged.js" ]; then
  node ./node_modules/lint-staged/bin/lint-staged.js
fi

if [ -f "./node_modules/typescript/bin/tsc" ]; then
  node ./node_modules/typescript/bin/tsc --noEmit
fi
